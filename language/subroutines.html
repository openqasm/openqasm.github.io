
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Subroutines &#8212; OpenQASM Live Specification  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/colors.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Directives" href="directives.html" />
    <link rel="prev" title="Classical instructions" href="classical.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="subroutines">
<h1>Subroutines<a class="headerlink" href="#subroutines" title="Permalink to this headline">¶</a></h1>
<p>Subroutines are declared using the statement</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">name(parameters)</span> <span class="pre">-&gt;</span> <span class="pre">output_type</span> <span class="pre">{</span> <span class="pre">body</span> <span class="pre">}</span></code></p>
</div></blockquote>
<p>Subroutines and their named arguments must be named according to the rules for
identifiers (See <a class="reference internal" href="types.html#identifiers"><span class="std std-ref">Identifiers</span></a>).</p>
<p>The subroutine will define zero or more parameters as input, consisting of both
quantum and classical arguments. Quantum bits and classical values are passed to
the subroutine by reference or name, while classical types are passed in by value.
All arguments are declared together with their type. For example, <code class="docutils literal notranslate"><span class="pre">qubit</span> <span class="pre">ancilla</span></code>
defines a quantum bit argument named <code class="docutils literal notranslate"><span class="pre">ancilla</span></code>.</p>
<p>The subroutines return up to one value of classical type, signified by the
<code class="docutils literal notranslate"><span class="pre">return</span></code> keyword. If there is no return type, the empty <code class="docutils literal notranslate"><span class="pre">return</span></code>
keyword may be used to immediately exit from the subroutine.</p>
<p>Qubit declarations are not allowed within subroutines as those declarations are global.</p>
<p>A subroutine is invoked with the syntax <code class="docutils literal notranslate"><span class="pre">name(parameters)</span></code> and may be assigned
to an <code class="docutils literal notranslate"><span class="pre">output</span></code> as needed via an assignment operator (<code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">+=</span></code>, etc).</p>
<p>Using subroutines, we can define an X-basis measurement with the program</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">xmeasure(qubit</span> <span class="pre">q)</span> <span class="pre">-&gt;</span> <span class="pre">bit</span> <span class="pre">{</span> <span class="pre">h</span> <span class="pre">q;</span> <span class="pre">return</span> <span class="pre">measure</span> <span class="pre">q;</span> <span class="pre">}</span></code></p>
</div></blockquote>
<p>We can also define more general classes of single-qubit measurements
as</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">pmeasure(angle[32]</span> <span class="pre">theta,</span> <span class="pre">qubit</span> <span class="pre">q)</span> <span class="pre">-&gt;</span> <span class="pre">bit</span> <span class="pre">{rz(theta)</span> <span class="pre">q;</span> <span class="pre">h</span> <span class="pre">q;</span> <span class="pre">return</span> <span class="pre">measure</span> <span class="pre">q;}</span></code></p>
</div></blockquote>
<p>The type declarations are necessary if we want to mix qubit and
register arguments. For example, we might define a parity check
subroutine that takes qubits and registers</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="nf">xcheck</span><span class="p">(</span><span class="n">qubit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">qubit</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">reset</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="n">cx</span><span class="w"> </span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">measure</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Naturally we can also use subroutines to define purely classical
operations, such as methods we can implement using low-level classical
instructions, like</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* some size, known at compile time */</span><span class="p">;</span><span class="w"></span>
<span class="n">def</span><span class="w"> </span><span class="nf">parity</span><span class="p">(</span><span class="n">bit</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="n">cin</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">bit</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">cin</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>We can make some measurements and call this subroutine on the results as
follows</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">qubit</span><span class="w"> </span><span class="n">q</span><span class="p">;</span><span class="w"></span>
<span class="n">qubit</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measure</span><span class="w"> </span><span class="n">q</span><span class="p">;</span><span class="w"></span>
<span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measure</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="n">bit</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parity</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">c2</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>We require that we know the signature at compile time, as we do in this
example. We could also just as easily have used an extern function for
this</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* size of c + size of c2 */</span><span class="p">;</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">parity</span><span class="p">(</span><span class="n">bit</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">bit</span><span class="p">;</span><span class="w"></span>
<span class="n">qubit</span><span class="w"> </span><span class="n">q</span><span class="p">;</span><span class="w"></span>
<span class="n">qubit</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measure</span><span class="w"> </span><span class="n">q</span><span class="p">;</span><span class="w"></span>
<span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">measure</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="n">bit</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parity</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c2</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<section id="arrays-in-subroutines">
<span id="id1"></span><h2>Arrays in subroutines<a class="headerlink" href="#arrays-in-subroutines" title="Permalink to this headline">¶</a></h2>
<p>Arrays may be passed as parameters to subroutines and externs. All array
parameters are passed as references and must include a type modifier specifying
if the parameter is <code class="docutils literal notranslate"><span class="pre">const</span></code> or <code class="docutils literal notranslate"><span class="pre">mutable</span></code>. The number of dimensions for all
array parameters must be specified using the <code class="docutils literal notranslate"><span class="pre">#dim</span> <span class="pre">=</span> <span class="pre">literal/const</span> <span class="pre">identifier</span></code>
syntax below, or specific lengths for each dimension must be provided.
The unspecified-length version is provided because the lengths of
the dimensions of array parameters (in the case of strided access) may not be
known until runtime. Passing multiple overlapping mutable references to the same
array to a subroutine is forbidden. However, the compiler will not always be
able to resolve when this happens, and if it does, then no guarantees are made
about the order that updates are made in.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>def specified_sub(const array[int[8], 2, 10] arr_arg) {...}
def arr_subroutine(const array[int[8], #dim = 1] arr_arg) {...}
def mut_subroutine(mutable array[int[8], #dim = 1] arr_arg) {
  arr_arg[2] = 10; // allowed
  ...
}
array[int[8], 5] aa;
array[int[8], 3, 5] bb;

arr_subroutine(aa);
arr_subroutine(bb[1, 0:3]);
mut_subroutine(aa[1:3]); // aa[3] = 10
</pre></div>
</div>
<p>The lifetime of the array reference is limited to within the scope of the
subroutine definition, but it should be noted that since arrays are not
dynamically allocated the memory associated with the array stays intact after
subroutine exit. Additionally, the OpenQASM3 language is not anticipated to
support explicit user-controlled creation of pointers and references outside
of the specific context of passing arrays to subroutines.</p>
<p>The dimensions of arrays may be queried inside of subroutines using the built-in
<code class="docutils literal notranslate"><span class="pre">sizeof()</span></code> function, which takes two parameters: the array being queried, and
the zero-based dimension number requested. If the second parameter is omitted,
then it defaults to <code class="docutils literal notranslate"><span class="pre">0</span></code>, <em>i.e.</em> <code class="docutils literal notranslate"><span class="pre">sizeof(arr)</span> <span class="pre">==</span> <span class="pre">sizeof(arr,</span> <span class="pre">0)</span></code>.
<code class="docutils literal notranslate"><span class="pre">sizeof()</span></code> returns a <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">uint</span></code> representing the length of the
requested dimension of the array argument. The array argument can be
subscripted, meaning that <code class="docutils literal notranslate"><span class="pre">sizeof(arr[0],</span> <span class="pre">0)</span> <span class="pre">==</span> <span class="pre">sizeof(arr,</span> <span class="pre">1)</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>def arr_subroutine(const array[int[8], #dim = 2] twoD_arg) {
  uint[32] firstDim  = sizeof(twoD_arg, 0);
  uint[32] secondDim = sizeof(twoD_arg, 1);
  int[32] sum = 0;
  for ii in [0:firstDim-1] {
    for jj in [0:secondDim-1] {
      sum += int[32](twoD_arg[ii][jj]);
    }
  }
  ...
}
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">OpenQASM Live Specification</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Language</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="comments.html">Comments</a></li>
<li class="toctree-l2"><a class="reference internal" href="comments.html#version-string">Version string</a></li>
<li class="toctree-l2"><a class="reference internal" href="comments.html#included-files">Included files</a></li>
<li class="toctree-l2"><a class="reference internal" href="types.html">Types and Casting</a></li>
<li class="toctree-l2"><a class="reference internal" href="gates.html">Gates</a></li>
<li class="toctree-l2"><a class="reference internal" href="insts.html">Built-in quantum instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="classical.html">Classical instructions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Subroutines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#arrays-in-subroutines">Arrays in subroutines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="directives.html">Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="directives.html#input-output">Input/output</a></li>
<li class="toctree-l2"><a class="reference internal" href="delays.html">Circuit timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="pulses.html">Pulse-level descriptions of gates and measurement</a></li>
<li class="toctree-l2"><a class="reference internal" href="openpulse.html">OpenPulse Grammar</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../grammar/index.html">OpenQasm 3.0 Grammar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Language</a><ul>
      <li>Previous: <a href="classical.html" title="previous chapter">Classical instructions</a></li>
      <li>Next: <a href="directives.html" title="next chapter">Directives</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017-2020, Andrew W. Cross, Lev S. Bishop, John A. Smolin, Jay M. Gambetta.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/language/subroutines.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>